!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports["grapesjs-code-editor"]=t():e["grapesjs-code-editor"]=t()}(self,(()=>(()=>{"use strict";var e={d:(t,n)=>{for(var o in n)e.o(n,o)&&!e.o(t,o)&&Object.defineProperty(t,o,{enumerable:!0,get:n[o]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};function n(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,o)}return n}function i(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?o(Object(i),!0).forEach((function(t){n(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):o(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}function r(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,o=new Array(t);n<t;n++)o[n]=e[n];return o}function s(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function c(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,o)}return n}function a(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?c(Object(n),!0).forEach((function(t){s(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):c(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e){return function t(){for(var n=this,o=arguments.length,i=new Array(o),r=0;r<o;r++)i[r]=arguments[r];return i.length>=e.length?e.apply(this,i):function(){for(var e=arguments.length,o=new Array(e),r=0;r<e;r++)o[r]=arguments[r];return t.apply(n,[].concat(i,o))}}}function d(e){return{}.toString.call(e).includes("Object")}function u(e){return"function"==typeof e}e.r(t),e.d(t,{default:()=>N});var p=l((function(e,t){throw new Error(e[t]||e.default)}))({initialIsRequired:"initial state is required",initialType:"initial state should be an object",initialContent:"initial state shouldn't be an empty object",handlerType:"handler should be an object or a function",handlersType:"all handlers should be a functions",selectorType:"selector should be a function",changeType:"provided value of changes should be an object",changeField:'it seams you want to change a field in the state which is not specified in the "initial" state',default:"an unknown error accured in `state-local` package"}),h=function(e,t){return d(t)||p("changeType"),Object.keys(t).some((function(t){return n=e,o=t,!Object.prototype.hasOwnProperty.call(n,o);var n,o}))&&p("changeField"),t},f=function(e){u(e)||p("selectorType")},g=function(e){u(e)||d(e)||p("handlerType"),d(e)&&Object.values(e).some((function(e){return!u(e)}))&&p("handlersType")},m=function(e){var t;e||p("initialIsRequired"),d(e)||p("initialType"),t=e,Object.keys(t).length||p("initialContent")};function b(e,t){return u(t)?t(e.current):t}function v(e,t){return e.current=a(a({},e.current),t),t}function y(e,t,n){return u(t)?t(e.current):Object.keys(n).forEach((function(n){var o;return null===(o=t[n])||void 0===o?void 0:o.call(t,e.current[n])})),n}const C=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};m(e),g(t);var n={current:e},o=l(y)(n,t),i=l(v)(n),r=l(h)(e),s=l(b)(n);return[function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:function(e){return e};return f(e),e(n.current)},function(e){!function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return function(e){return t.reduceRight((function(e,t){return t(e)}),e)}}(o,i,r,s)(e)}]};var w,P={configIsRequired:"the configuration object is required",configType:"the configuration object should be an object",default:"an unknown error accured in `@monaco-editor/loader` package",deprecation:"Deprecation warning!\n    You are using deprecated way of configuration.\n\n    Instead of using\n      monaco.config({ urls: { monacoBase: '...' } })\n    use\n      monaco.config({ paths: { vs: '...' } })\n\n    For more please check the link https://github.com/suren-atoyan/monaco-loader#config\n  "},O=(w=function(e,t){throw new Error(e[t]||e.default)},function e(){for(var t=this,n=arguments.length,o=new Array(n),i=0;i<n;i++)o[i]=arguments[i];return o.length>=w.length?w.apply(this,o):function(){for(var n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return e.apply(t,[].concat(o,i))}})(P);const S={config:function(e){return e||O("configIsRequired"),t=e,{}.toString.call(t).includes("Object")||O("configType"),e.urls?(console.warn(P.deprecation),{paths:{vs:e.urls.monacoBase}}):e;var t}},E=function e(t,n){return Object.keys(n).forEach((function(o){n[o]instanceof Object&&t[o]&&Object.assign(n[o],e(t[o],n[o]))})),i(i({},t),n)};var j={type:"cancelation",msg:"operation is manually canceled"};const k=function(e){var t=!1,n=new Promise((function(n,o){e.then((function(e){return t?o(j):n(e)})),e.catch(o)}));return n.cancel=function(){return t=!0},n};var x,T=(2,function(e){if(Array.isArray(e))return e}(x=C({config:{paths:{vs:"https://cdn.jsdelivr.net/npm/monaco-editor@0.36.1/min/vs"}},isInitialized:!1,resolve:null,reject:null,monaco:null}))||function(e,t){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e)){var n=[],o=!0,i=!1,r=void 0;try{for(var s,c=e[Symbol.iterator]();!(o=(s=c.next()).done)&&(n.push(s.value),2!==n.length);o=!0);}catch(e){i=!0,r=e}finally{try{o||null==c.return||c.return()}finally{if(i)throw r}}return n}}(x)||function(e,t){if(e){if("string"==typeof e)return r(e,2);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?r(e,2):void 0}}(x)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()),M=T[0],I=T[1];function L(e){return document.body.appendChild(e)}function D(e){var t=M((function(e){return{config:e.config,reject:e.reject}})),n=function(e){var t=document.createElement("script");return e&&(t.src=e),t}("".concat(t.config.paths.vs,"/loader.js"));return n.onload=function(){return e()},n.onerror=t.reject,n}function A(){var e=M((function(e){return{config:e.config,resolve:e.resolve,reject:e.reject}})),t=window.require;t.config(e.config),t(["vs/editor/editor.main"],(function(t){H(t),e.resolve(t)}),(function(t){e.reject(t)}))}function H(e){M().monaco||I({monaco:e})}var V=new Promise((function(e,t){return I({resolve:e,reject:t})})),W={config:function(e){var t=S.config(e),n=t.monaco,o=function(e,t){if(null==e)return{};var n,o,i=function(e,t){if(null==e)return{};var n,o,i={},r=Object.keys(e);for(o=0;o<r.length;o++)n=r[o],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(o=0;o<r.length;o++)n=r[o],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}(t,["monaco"]);I((function(e){return{config:E(e.config,o),monaco:n}}))},init:function(){var e=M((function(e){return{monaco:e.monaco,isInitialized:e.isInitialized,resolve:e.resolve}}));if(!e.isInitialized){if(I({isInitialized:!0}),e.monaco)return e.resolve(e.monaco),k(V);if(window.monaco&&window.monaco.editor)return H(window.monaco),e.resolve(window.monaco),k(V);!function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return function(e){return t.reduceRight((function(e,t){return t(e)}),e)}}(L,D)(A)}return k(V)},__getMonacoInstance:function(){return M((function(e){return e.monaco}))}};const z=W;class R{constructor(e,t){this.editor=e,this.$=e.$,this.pfx=e.getConfig("stylePrefix"),this.opts=t,this.canvas=this.findWithinEditor(`.${this.pfx}cv-canvas`),this.panelViews=t.appendTo?this.$(t.appendTo):this.findWithinEditor(`.${this.pfx}pn-${t.panelId}`),this.isShowing=!0,this.blockPage=()=>!1,t.blockPage&&t.blockPage.block&&(this.blockPage=e=>t.blockPage.block.apply(null,[e])),this.unblockPage=()=>!1,t.blockPage&&t.blockPage.unblock&&(this.unblockPage=e=>t.blockPage.unblock.apply(null,[e])),this.configEditor=t.configEditor,this.acceptJS=t.acceptJS,this.classOpenCode=t.classOpenCode,this.htmlMonacoEditor=null,this.cssMonacoEditor=null}findPanel(){const e=this.editor.Panels,t=this.opts.panelId;return e.getPanel(t)||e.addPanel({id:t})}findWithinEditor(e){return this.$(e,this.editor.getEl())}buildSection(e,t){const{$:n,pfx:o,opts:i}=this,r=n("<section></section>"),s="html"===e?i.htmlBtnText:i.cssBtnText;r.append(n(`\n            <div class="codepanel-separator">\n                <div class="codepanel-label">${e}</div>\n                <div class="cp-btn-container">\n                    <button class="cp-apply-${e} ${o}btn-prim">${s}</button>\n                </div>\n            </div>`));const c=t;return c.style.height="calc(100% - 30px)",r.append(c),this.codePanel.append(r),r.get(0)}buildCodePanel(){const{$:e,editor:t}=this;this.blockPage(null),this.codePanel=e("<div></div>"),this.codePanel.addClass("code-panel"),this.htmlCodeEditor=document.createElement("div"),this.htmlCodeEditor.id="editor-html",this.cssCodeEditor=document.createElement("div"),this.cssCodeEditor.id="editor-css",this.monacoEditorLoader=z.init().then((e=>{this.monacoEditor=e,this.criaCodePanel()}))}criaCodePanel(){const{$:e,editor:t}=this,n=this.opts.panelId?this.findPanel():0;this.buildSection("html",this.htmlCodeEditor),this.buildSection("css",this.cssCodeEditor),n&&!this.opts.appendTo&&n.set("appendContent",this.codePanel).trigger("change:appendContent"),this.opts.appendTo&&e(this.opts.appendTo).append(this.codePanel),this.htmlMonacoEditor=this.monacoEditor.editor.create(this.htmlCodeEditor,{value:"",language:"html",...this.configEditor}),this.createAutoClose(this.htmlMonacoEditor),this.cssMonacoEditor=this.monacoEditor.editor.create(this.cssCodeEditor,{value:"",language:"css",...this.configEditor}),this.htmlMonacoEditor.onDidChangeModelContent((e=>{e.isFlush?setTimeout((()=>{this.htmlMonacoEditor.getAction("editor.action.formatDocument").run().then((()=>this.unblockPage(this.htmlCodeEditor)))}),300):this.unblockPage(this.htmlCodeEditor)})),this.cssMonacoEditor.onDidChangeModelContent((e=>{e.isFlush?setTimeout((()=>{this.cssMonacoEditor.getAction("editor.action.formatDocument").run().then((()=>this.unblockPage(this.cssCodeEditor)))}),300):this.unblockPage(this.cssCodeEditor)})),this.updateEditorContents(),this.codePanel.find(".cp-apply-html").on("click",this.updateHtml.bind(this)),this.codePanel.find(".cp-apply-css").on("click",this.updateCss.bind(this)),t.on("component:update",(e=>this.updateEditorContents())),t.on("component:selected",(e=>this.updateEditorContents())),t.on("stop:preview",(()=>{this.isShowing&&!this.opts.preserveWidth&&this.canvas.css("width",this.opts.openState.cv)})),this.unblockPage(null),this.unblockPage(this.htmlCodeEditor),this.unblockPage(this.cssCodeEditor)}createAutoClose(e){e.onKeyDown((t=>{const n=e.getModel();if(!["html"].includes(n.getLanguageId()))return;const o=e=>["area","base","br","col","command","embed","hr","img","input","keygen","link","meta","param","source","track","wbr","circle","ellipse","line","path","polygon","polyline","rect","stop","use"].includes(e),i=e=>["html","head","body","script"].includes(e);if(">"===t.browserEvent.key){const t=e.getSelections(),r=[],s=[];for(const e of t){s.push(new monaco.Selection(e.selectionStartLineNumber,e.selectionStartColumn+1,e.endLineNumber,e.endColumn+1));const t=n.getValueInRange({startLineNumber:1,startColumn:1,endLineNumber:e.endLineNumber,endColumn:e.endColumn}).match(/<([\w-]+)(?![^>]*\/>)[^>]*$/);if(!t)continue;const[c,a]=t;if(i(a))return!1;o(a)||c.trim().endsWith("/")||r.push({range:{startLineNumber:e.endLineNumber,startColumn:e.endColumn+1,endLineNumber:e.endLineNumber,endColumn:e.endColumn+1},text:`</${a}>`})}setTimeout((()=>{e.executeEdits(n.getValue(),r,s)}),0)}}))}showCodePanel(){if(this.isShowing=!0,this.updateEditorContents(),this.codePanel.css("display","block"),this.opts.preserveWidth)return;if(this.opts.classOpenCode&&this.opts.classOpenCode.cv&&this.opts.classOpenCode.pn)return this.panelViews.addClass(this.opts.classOpenCode.pn),void this.canvas.addClass(this.opts.classOpenCode.cv);let e=this.opts.openState.pn;"function"==typeof this.opts.openState.pn&&(e=this.opts.openState.pn(this));let t=this.opts.openState.cv;"function"==typeof this.opts.openState.cv&&(t=this.opts.openState.cv(this)),this.panelViews.css("width",e),this.canvas.css("width",t)}hideCodePanel(){if(this.codePanel&&this.codePanel.css("display","none"),this.isShowing=!1,this.opts.preserveWidth)return;if(this.opts.classOpenCode&&this.opts.classOpenCode.cv&&this.opts.classOpenCode.pn)return this.panelViews.removeClass(this.opts.classOpenCode.pn),void this.canvas.removeClass(this.opts.classOpenCode.cv);let e=this.opts.closedState.pn;"function"==typeof this.opts.closedState.pn&&(e=this.opts.closedState.pn(this));let t=this.opts.closedState.cv;"function"==typeof this.opts.closedState.cv&&(t=this.opts.closedState.cv(this)),this.panelViews.css("width",e),this.canvas.css("width",t)}updateHtml(e){e?.preventDefault();const{editor:t}=this,n=this.editor.getSelected();let o=this.htmlMonacoEditor.getValue().trim();if(o===this.previousHtmlCode||!n)return void t.em.logWarning("Código HTML não foi aplicado");const i=/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gm,r=/<script+.*>/gm;try{this.acceptJS||!i.test(o)&&!r.test(o)||(t.em.logError("Não é permitido inserir conteúdo JavaScript, o conteúdo script não será aplicado"),o=o.replace(i,""),o=o.replace(r,""),this.htmlMonacoEditor.getModel().setValue(this.previousHtmlCode))}catch(e){}o=o.replace(/<\/?body[^>]*>/gi,""),o=o.replace(/<\/?head[^>]*>/gi,""),o=o.replace(/<\/?html[^>]*>/gi,""),this.blockPage(null);try{this.previousHtmlCode=o;let e="";this.cssMonacoEditor.getValue().split("}\n").filter((e=>Boolean(e.trim()))).map((e=>(e=e.trim(),/}$/.test(e)?e:`${e}}`))).forEach((t=>{/^#/.test(t)&&(e+=t)})),""!=e&&(o+=`<style>${e}</style>`),"wrapper"===n.attributes.type?t.setComponents(o):t.select(n.replaceWith(o))}catch(e){return this.unblockPage(null),t.em.logError("Erro ao aplicar o código HTML: "+e.message),o}this.unblockPage(null),t.em.logInfo("Código HTML aplicado com sucesso")}updateCss(e){e?.preventDefault();const{editor:t}=this,n=this.cssMonacoEditor.getValue().trim();if(n===this.previousCssCode)return void t.em.logWarning("Código CSS não foi aplicado");const o=this.editor.getSelected();this.blockPage(null);try{if("wrapper"===o.attributes.type)t.Css.clear(),this.editor.Css.addRules(n);else{const e=this.editor.Styles.getSelected()||void 0,t=this.editor.Css,o=e.getComponent().getId(),i=t.getRules(`#${o}`);i&&i.length>1&&this.editor.Css.remove(i),i&&e?.setStyle(""),this.editor.Css.addRules(n)}this.previousCssCode=n}catch(e){return this.unblockPage(null),void t.em.logError("Erro ao aplicar o código CSS: "+e.message)}return this.unblockPage(null),t.em.logInfo("Código CSS aplicado com sucesso"),n}updateEditorContents(){const{editor:e}=this;this.isShowing&&(this.blockPage(this.htmlCodeEditor),this.blockPage(this.cssCodeEditor),setTimeout((()=>{const t=this.editor.getSelected();if(t){this.htmlMonacoEditor&&(this.previousHtmlCode=this.getComponentHtml(t),this.htmlMonacoEditor.getModel().setValue(this.previousHtmlCode));const n=e.Styles.getSelected()||void 0;if(this.cssMonacoEditor&&n)if(t.components().length)this.previousCssCode=this.editor.CodeManager.getCode(t,"css",{cssc:this.editor.Css}),this.cssMonacoEditor.getModel().setValue(this.previousCssCode);else{const o=e.Css,i=n.getComponent().getId(),r=o.getRules(`#${i}`);this.previousCssCode="";for(const e of r)this.previousCssCode+=`${e.toCSS()} `;this.previousCssCode=$.trim(this.previousCssCode),""==this.previousCssCode&&(this.previousCssCode=n?this.cssFormat(n?.toCSS({allowEmpty:!0})):""),t.getClasses().map((t=>{const n=e.Css.getRule(`.${t}`);n&&(this.previousCssCode+=`${n.toCSS()} `)})),this.cssMonacoEditor.getModel().setValue(this.previousCssCode)}}}),10))}getComponentHtml(e){const{pfx:t,opts:n}=this;let o="";const i=e.getEl();!n.clearData&&i.classList.remove(`${t}selected`);const r=n.clearData?e.toHTML():"wrapper"===e.attributes.type?i.innerHTML:i.outerHTML;!n.clearData&&i.classList.add(`${t}selected`),o+=r;const s=n.editJs?e.getScriptString():"";return o+=s?`<script>${s}<\/script>`:"",o}cssFormat(e){return(e=(e=(e=(e=(e=e.replace(/\s*([\{\}\:\;\,])\s*/g,"$1")).replace(/;\s*;/g,";")).replace(/\,[\s\.\#\d]*{/g,"{")).replace(/([^\s])\{([^\s])/g,"$1 {\n\t$2")).replace(/([^\s])\}([^\n]*)/g,"$1\n}\n$2")).replace(/([^\s]);([^\s\}])/g,"$1;\n\t$2")}}const N=(e,t={})=>{const n="\n.code-panel {\n    text-align: left;\n    font-size: 1rem;\n    height: 100%;\n    overflow: hidden;\n}\n\n.code-panel section {\n    flex: 1;\n    height: 50%;\n}\n\n.code-panel section .codepanel-separator {\n    display: flex;\n    justify-content: space-between;\n    padding-left: 0.6rem;\n    padding-right: 0.6rem;\n}\n\n.code-panel section .codepanel-label {\n    margin-top: 5px;\n    line-height: 20px;\n    font-size: 13px;\n    color: #aaa;\n    user-select: none;\n    text-transform: uppercase;\n}\n\n.cp-btn-container {\n    display: flex;\n    justify-content: space-evenly;\n\n    & .#{$prefix}btn-prim {\n        margin: 2.5px;\n    }\n}\n\n.gutter {\n    cursor: ns-resize;\n    position: relative;\n    background-color: rgba(0, 0, 0, 0.2);\n}\n\n.gutter:after {\n    content: '';\n    display: block;\n    height: 8px;\n    width: 100%;\n    position: absolute;\n    top: -3px;\n    z-index: 150;\n}\n\n.code-panel .CodeMirror {\n    height: 100%;\n}\n\n.cp-delete-css {\n    margin-left: 70%;\n}\n\n.#{$prefix}pn-views {\n    border-left: 1px solid rgba(0, 0, 0, 0.2);\n    border-bottom: 0;\n}\n\n.#{$prefix}pn-views-container {\n    box-shadow: initial;\n    border-top: 2px solid rgba(0, 0, 0, 0.2);\n    top: 40px;\n    padding-top: 0;\n    height: calc(100% - 40px);\n}\n\n.#{$prefix}pn-views-container,\n.#{$prefix}cv-canvas {\n    transition: width 0.3s ease-in-out;\n}\n".replaceAll("#{$prefix}",e.getConfig("stylePrefix")),o=document.createElement("style");o.type="text/css",o.appendChild(document.createTextNode(n)),document.head.appendChild(o),((e,t)=>{const n=e.Commands;let o=null;n.add("code-editor",{run:(e,n)=>{!o&&(o=new R(e,t))&&o.buildCodePanel(),o.showCodePanel(n)},stop:(e,t)=>{o.hideCodePanel(t)}})})(e,{panelId:"views-container",appendTo:"",openState:{cv:"65%",pn:"35%"},closedState:{cv:"85%",pn:"15%"},classOpenCode:{cv:"code-editor-aberto",pn:"code-editor-aberto"},preserveWidth:!1,editJs:!1,htmlBtnText:"Aplicar",cssBtnText:"Aplicar",blockPage:null,acceptJS:!1,configEditor:{wordWrap:"on",minimap:{enabled:!1},scrollBeyondLastLine:!1,contextmenu:!1,fixedOverflowWidgets:!0,showFoldingControls:"always",suggestOnTriggerCharacters:!0,lineDecorationsWidth:0,tabSize:3,formatOnType:!0,formatOnPaste:!0,autoIndent:!0,autoClosingBrackets:!0,autoClosingPairs:!0,fontSize:"12px",scrollbar:{verticalScrollbarSize:8,horizontal:"hidden"}},...t})};return t})()));